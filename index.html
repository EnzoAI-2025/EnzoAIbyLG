<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enzo.AI ‚Äî Mini Intelig√™ncia Artificial</title>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#10b981;--muted:#94a3b8;--glass:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:linear-gradient(180deg,#071026 0%,#041421 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;transition:background .3s ease,color .3s ease}
    body.light{background:linear-gradient(180deg,#f0f4f8 0%,#d9e2ec 100%);color:#1e293b}
    .app{width:100%;max-width:940px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center}
    .logo{width:80px;height:80px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:22px;color:#fff;letter-spacing:-1px;text-shadow:0 0 12px rgba(16,185,129,0.6);box-shadow:0 0 15px rgba(16,185,129,0.15);overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:cover}
    h1{margin:0;font-size:20px}
    p.lead{margin:4px 0 12px;color:var(--muted);font-size:13px}
    .chat{background:var(--card);border-radius:12px;padding:14px;min-height:320px;max-height:60vh;overflow:auto}
    body.light .chat{background:#fff}
    .msg{padding:10px 12px;margin-bottom:8px;border-radius:10px;max-width:78%}
    .user{background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));margin-left:auto;border-top-right-radius:2px}
    .bot{background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
    .meta{font-size:11px;color:var(--muted);margin-bottom:6px}
    .controls{display:flex;gap:8px;margin-top:12px}
    input[type=text]{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    button{padding:10px 14px;border-radius:10px;border:0;background:var(--accent);color:#072018;font-weight:600;cursor:pointer;transition:opacity .2s ease}
    button:hover{opacity:0.85}
    .small{font-size:12px;color:var(--muted)}
    .suggestions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .actions button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;border-radius:8px}
    .typing{display:inline-block;height:8px;width:36px}
    .result-source{font-size:11px;color:var(--muted);margin-top:6px}
    .settings{display:flex;gap:8px;align-items:center}
    @media (max-width:820px){.app{padding:12px}.logo{width:60px;height:60px}}
  </style>
</head>
<body>
  <main class="app" role="main">
    <header>
      <div class="logo" id="logoWrap">
        <!-- logo image will be injected by JS -->
      </div>
      <div style="flex:1">
        <h1 id="title">Enzo.AI ‚Äî sua mini IA local</h1>
        <p class="lead">Interface futurista com voz, tema, busca integrada e respostas inteligentes (ChatGPT-like).</p>
      </div>
      <div class="settings">
        <button id="setKeys">Configurar API Keys</button>
        <button id="theme">Tema</button>
      </div>
    </header>

    <section class="chat" id="chat" aria-live="polite"></section>

    <div class="suggestions" id="sugs">
      <div class="chip">Ol√°</div>
      <div class="chip">Pesquisar: Dom Pedro I</div>
      <div class="chip">Que dia √© hoje?</div>
      <div class="chip">Conte uma piada</div>
    </div>

    <div class="controls">
      <input id="input" type="text" placeholder="Digite sua mensagem para Enzo.AI... (ex: Pesquisar: bras√≠lia)" aria-label="Mensagem para Enzo AI" />
      <button id="send">Enviar</button>
      <button id="voice">üéôÔ∏è</button>
      <button id="export">Exportar (.txt)</button>
    </div>

    <footer>
      <div class="small">Enzo.AI ‚Äî Powered by Web Speech + OpenAI + SerpAPI</div>
      <div class="actions">
        <button id="clear">Limpar</button>
      </div>
    </footer>
  </main>

  <script>
    // --------- CONFIG ---------
    // Logo path (replace with your uploaded image path)
    const LOGO_PATH = '/mnt/data/a971b6f1-c742-48dd-95f0-38eb4e1f535d.png';

    // Services used:
    // - OpenAI for conversational responses (requires key stored in localStorage 'openai_key')
    // - SerpAPI for Google-like search (requires key stored in localStorage 'serpapi_key')

    // --------- UI ELEMENTS ---------
    const chatEl=document.getElementById('chat');
    const input=document.getElementById('input');
    const send=document.getElementById('send');
    const sugs=document.getElementById('sugs');
    const clearBtn=document.getElementById('clear');
    const exportBtn=document.getElementById('export');
    const themeBtn=document.getElementById('theme');
    const voiceBtn=document.getElementById('voice');
    const setKeysBtn=document.getElementById('setKeys');
    const logoWrap=document.getElementById('logoWrap');

    // Inject logo image
    const logoImg=document.createElement('img');logoImg.src=LOGO_PATH;logoImg.alt='EnzoIA Logo';logoWrap.appendChild(logoImg);

    // --------- UTILITIES ---------
    function escapeHtml(t){return t.replace(/[&<>"]+/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])||m);} 
    function appendMessage(text,who='bot',metaExtra=''){
      const wrap=document.createElement('div');wrap.className='msg '+(who==='user'?'user':'bot');
      const meta=document.createElement('div');meta.className='meta';meta.textContent=who==='user'?'Voc√™':'Enzo.AI';
      if(metaExtra) meta.textContent += ' ¬∑ ' + metaExtra;
      wrap.appendChild(meta);
      const body=document.createElement('div');body.className='body';body.innerHTML=text;wrap.appendChild(body);
      chatEl.appendChild(wrap);chatEl.scrollTop=chatEl.scrollHeight;
      if(who==='bot') speak(body.innerText.replace(/<[^>]+>/g,''));
    }

    // Simple recognizer for search intent
    function isSearchIntent(t){return /\b(pesquis[ea]|pesquise|buscar|pesquisa|quem foi|quem √©|o que √©|conte sobre|resuma|procure)\b/i.test(t);} 

    // --------- VOICE (TTS + Recognition) ---------
    function speak(text){
      if(!('speechSynthesis' in window)) return;window.speechSynthesis.cancel();
      const utter=new SpeechSynthesisUtterance(text);utter.lang='pt-BR';utter.rate=1;utter.pitch=1;window.speechSynthesis.speak(utter);
    }
    const RecClass = window.SpeechRecognition||window.webkitSpeechRecognition||null;
    const rec = RecClass?new RecClass():null;
    if(rec){rec.lang='pt-BR';rec.onresult=e=>{input.value=e.results[0][0].transcript;send.click();};rec.onend=()=>voiceBtn.textContent='üéôÔ∏è';}
    voiceBtn.onclick=()=>{if(rec){rec.start();voiceBtn.textContent='üéß ouvindo...';}else alert('Reconhecimento de voz n√£o suportado neste navegador.');};

    // --------- STORAGE & KEYS ---------
    function promptForKeys(){
      const openaiKey = prompt('Cole sua OpenAI API Key (ex: sk-...) ‚Äî deixe vazio para usar respostas locais:');
      if(openaiKey) localStorage.setItem('openai_key', openaiKey.trim());
      const serpKey = prompt('Cole sua SerpAPI key (para buscas no estilo Google):');
      if(serpKey) localStorage.setItem('serpapi_key', serpKey.trim());
      alert('Chaves salvas no localStorage. Para seguran√ßa, n√£o compartilhe este computador.');
    }
    setKeysBtn.onclick = promptForKeys;

    // --------- SEARCH (SerpAPI) ---------
    // Uses SerpAPI JSON endpoint. Store key in localStorage as 'serpapi_key'.
    async function serpSearch(q){
      const key = localStorage.getItem('serpapi_key');
      if(!key) throw new Error('No SerpAPI key configured.');
      const params = new URLSearchParams({q,engine:'google',api_key:key,google_domain:'google.com',gl:'br',hl:'pt'});
      const url = `https://serpapi.com/search.json?${params.toString()}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('SerpAPI request failed');
      return await res.json();
    }

    function extractSerpSummary(json){
      // Try multiple fields: answer_box, knowledge_graph, local_map, snippets
      if(json.answer_box){
        const ab = json.answer_box;
        if(ab.answer) return {text:ab.answer, source:ab.source};
        if(ab.snippet) return {text:ab.snippet, source:ab.source};
      }
      if(json.knowledge_graph){
        const kg = json.knowledge_graph;
        let parts = [];
        if(kg.title) parts.push('<strong>'+escapeHtml(kg.title)+'</strong>');
        if(kg.description) parts.push(escapeHtml(kg.description));
        if(kg.type) parts.push('<em>'+escapeHtml(kg.type)+'</em>');
        return {text:parts.join('<br>'), source:kg.title||'Google'};
      }
      if(Array.isArray(json.organic_results) && json.organic_results.length){
        const top = json.organic_results[0];
        const snippet = top.snippet || top.title || '';
        return {text:escapeHtml(snippet), source:top.link||top.source || 'Resultado org√¢nico'};
      }
      return null;
    }

    // --------- OPENAI Conversational (optional) ---------
    async function openaiChat(prompt, system='Voc√™ √© Enzo.AI, um assistente simp√°tico e √∫til. Responda em portugu√™s.'){
      const key = localStorage.getItem('openai_key');
      if(!key) throw new Error('No OpenAI key');
      const body = {model:'gpt-3.5-turbo',messages:[{role:'system',content:system},{role:'user',content:prompt}],max_tokens:600,temperature:0.7};
      const r = await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)});
      if(!r.ok){const txt=await r.text();throw new Error(txt||'OpenAI error');}
      const j = await r.json();
      return j.choices?.[0]?.message?.content?.trim();
    }

    // --------- High-level reply orchestrator ---------
    async function handleUserMessage(text){
      appendMessage(escapeHtml(text),'user');
      const t = text.trim();
      // quick local replies
      if(/^que dia √© hoje\??/i.test(t) || /que dia √© hoje/i.test(t)){
        const d = new Date(); appendMessage(`<strong>Hoje √© ${d.toLocaleDateString('pt-BR', {weekday:'long', year:'numeric', month:'long', day:'numeric'})}.</strong>`,'bot'); saveToLocalStorage(); return;
      }
      if(/^conte uma piada|uma piada/i.test(t)){
        // use OpenAI if available otherwise local joke
        try{const joke = await tryOpenAIOrFallback('Conte uma piada curta e engra√ßada em portugu√™s.'); appendMessage(escapeHtml(joke).replace(/\n/g,'<br>'),'bot'); saveToLocalStorage(); return;}catch(e){appendMessage('Por que o livro foi ao m√©dico? Porque tinha muitas p√°ginas (piada simples).','bot');saveToLocalStorage();return}
      }
      if(/estou triste|me sinto triste/i.test(t)){
        try{const resp = await tryOpenAIOrFallback('O usu√°rio disse que est√° triste. Responda com empatia, 3 sugest√µes pr√°ticas para melhorar o humor e uma pequena afirma√ß√£o positiva. Em portugu√™s.'); appendMessage(escapeHtml(resp).replace(/\n/g,'<br>'),'bot'); saveToLocalStorage(); return;}catch(e){appendMessage('Sinto muito que voc√™ esteja triste. Respire fundo, converse com algu√©m de confian√ßa, e d√™ um pequeno passeio. Voc√™ √© importante.','bot');saveToLocalStorage();return}
      }

      // Search intent
      if(isSearchIntent(t)){
        const q = t.replace(/^(pesquise|pesquisar|pesquisa|buscar|procure|pesquis[ea]:?)/i,'').trim() || t;
        const typing = showTyping();
        try{
          // Attempt real SerpAPI search
          const serp = await serpSearch(q);
          const summary = extractSerpSummary(serp);
          if(summary){
            const html = `<div><strong>Resumo (busca):</strong><br>${summary.text}</div><div class="result-source">Fonte: ${escapeHtml(summary.source||'Google')}</div>`;
            typing.remove(); appendMessage(html,'bot', 'Pesquisa');
            saveToLocalStorage(); return;
          }
          // Fallback: ask OpenAI to summarize top results
          const snippets = (serp.organic_results||[]).slice(0,3).map(r=>r.snippet||r.title||'').join('\n');
          const prompt = `Resuma em 3 frases as informa√ß√µes abaixo (em portugu√™s):\n\n${snippets}`;
          const summaryText = await tryOpenAIOrFallback(prompt);
          typing.remove(); appendMessage(escapeHtml(summaryText).replace(/\n/g,'<br>'),'bot','Pesquisa'); saveToLocalStorage(); return;
        }catch(err){
          typing.remove();
          // If SerpAPI failed, try to use OpenAI to emulate a Google summary
          try{
            const emulate = await tryOpenAIOrFallback(`Finja que voc√™ pode pesquisar na web. Forne√ßa um resumo curto e confi√°vel para: "${q}" em portugu√™s (2-4 frases). Se n√£o tiver certeza, diga que n√£o h√° dados suficientes.`);
            appendMessage(escapeHtml(emulate).replace(/\n/g,'<br>'),'bot','Pesquisa (emulada)'); saveToLocalStorage(); return;
          }catch(e){
            appendMessage('Desculpe, n√£o consegui pesquisar agora. Quer que eu tente no Google abrindo uma nova aba?','bot'); saveToLocalStorage(); return;
          }
        }
      }

      // Default: use OpenAI if available, otherwise a simple fallback
      const typing = showTyping();
      try{
        const reply = await tryOpenAIOrFallback(t);
        typing.remove(); appendMessage(escapeHtml(reply).replace(/\n/g,'<br>'),'bot'); saveToLocalStorage();
      }catch(e){
        typing.remove(); appendMessage('N√£o entendi completamente. Quer que eu pesquise sobre isso?','bot'); saveToLocalStorage();
      }
    }

    function showTyping(){
      const typing=document.createElement('div');typing.className='msg bot';typing.innerHTML='<div class="meta">Enzo.AI</div><div class="body"><span class="typing">‚óè‚óè‚óè</span></div>';
      chatEl.appendChild(typing);chatEl.scrollTop=chatEl.scrollHeight;return typing;
    }

    async function tryOpenAIOrFallback(prompt){
      const key = localStorage.getItem('openai_key');
      if(key){
        try{ return await openaiChat(prompt); }catch(e){console.warn('OpenAI failed',e);}
      }
      // fallback: small local heuristics or canned answers
      // For generic prompts, ask a thin local model (very simple)
      if(/piada|conte uma piada/i.test(prompt)) return 'Por que o programador sempre confunde Halloween com o Natal? Porque OCT 31 == DEC 25.';
      if(prompt.length < 200) return 'Desculpe, n√£o posso acessar a API. Ative sua OpenAI key em "Configurar API Keys" para respostas completas.';
      return 'Desculpe, n√£o foi poss√≠vel obter uma resposta externa.';
    }

    // --------- Persistence ---------
    function saveToLocalStorage(){localStorage.setItem('enzo_chat',chatEl.innerHTML);}    
    function loadFromLocalStorage(){const h=localStorage.getItem('enzo_chat');if(h){chatEl.innerHTML=h;chatEl.scrollTop=chatEl.scrollHeight;}else appendMessage('Ol√°! Eu sou o Enzo.AI com voz e busca integrada. Use "Pesquisar: ..." para buscar no Google dentro do chat.','bot');}

    clearBtn.onclick=()=>{chatEl.innerHTML='';localStorage.removeItem('enzo_chat');appendMessage('Conversa limpa.','bot');};
    exportBtn.onclick=()=>{const lines=[...chatEl.querySelectorAll('.msg')].map(m=>`${m.querySelector('.meta')?.textContent}: ${m.querySelector('.body')?.innerText}`).join('\n\n');const blob=new Blob([lines],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='conversa_enzoai.txt';a.click();};
    themeBtn.onclick=()=>{document.body.classList.toggle('light');};

    send.onclick=()=>{const v=input.value;if(!v.trim())return;handleUserMessage(v);input.value='';input.focus();};
    input.onkeydown=e=>{if(e.key==='Enter'){e.preventDefault();send.click();}};
    document.querySelectorAll('.chip').forEach(c=>c.onclick=()=>{input.value=c.textContent;input.focus();});

    // load
    loadFromLocalStorage();

    // periodic save
    setInterval(saveToLocalStorage,5000);

    // small welcome tip to set keys
    setTimeout(()=>{if(!localStorage.getItem('openai_key')||!localStorage.getItem('serpapi_key')){
      appendMessage('<em>Dica:</em> Clique em "Configurar API Keys" para inserir sua OpenAI key (respostas avan√ßadas) e SerpAPI key (resultados de busca estilo Google).','bot');
    }},1200);

  </script>
</body>
</html>
